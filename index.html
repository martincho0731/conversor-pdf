<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertir a PDF</title>
    <link rel="manifest" href="manifest.json">

    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Sube tu archivo para convertirlo a PDF</h1>
        <input type="file" id="fileInput" accept=".txt,.docx,.jpg,.png,.pdf">
        <button id="convertBtn">Convertir a PDF</button>
        <div id="preview"></div>
        <a id="downloadLink" style="display:none;">Descargar PDF</a>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.16.0/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script>
        document.getElementById("convertBtn").addEventListener("click", async function() {
            const fileInput = document.getElementById("fileInput");
            if (!fileInput.files.length) {
                alert("Por favor, selecciona un archivo.");
                return;
            }
            const file = fileInput.files[0];
            const fileType = file.type;
            const pdfDoc = await PDFLib.PDFDocument.create();

            if (fileType.includes("text") || file.name.endsWith(".txt")) {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    const text = event.target.result;
                    document.getElementById("preview").textContent = text;
                    await addTextToPDF(pdfDoc, text);
                };
                reader.readAsText(file, "UTF-8");
            } else if (fileType.includes("image")) {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    const imageBytes = new Uint8Array(event.target.result);
                    await addImageToPDF(pdfDoc, imageBytes, fileType);
                };
                reader.readAsArrayBuffer(file);
            } else if (file.name.endsWith(".docx")) {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    const docText = await mammoth.extractRawText({ arrayBuffer: event.target.result });
                    document.getElementById("preview").textContent = docText.value;
                    await addTextToPDF(pdfDoc, docText.value);
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert("Formato no soportado.");
                return;
            }
        });

        async function addTextToPDF(pdfDoc, text) {
            const lines = text.split("\n");
            const maxLinesPerPage = 40;
            let page;
            let y = 750;
            
            for (let i = 0; i < lines.length; i++) {
                if (i % maxLinesPerPage === 0) {
                    page = pdfDoc.addPage([600, 800]);
                    y = 750;
                }
                page.drawText(lines[i], { x: 50, y, size: 12, font: await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica) });
                y -= 20;
            }
            await saveAndDownloadPDF(pdfDoc);
        }
        
        async function addImageToPDF(pdfDoc, imageBytes, fileType) {
            let image;
            if (fileType.includes("png")) {
                image = await pdfDoc.embedPng(imageBytes);
            } else {
                image = await pdfDoc.embedJpg(imageBytes);
            }
            const page = pdfDoc.addPage([600, 800]);
            const { width, height } = image.scale(0.5);
            page.drawImage(image, { x: 50, y: 400, width, height });
            await saveAndDownloadPDF(pdfDoc);
        }
        
        async function saveAndDownloadPDF(pdfDoc) {
            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: "application/pdf" });
            const url = URL.createObjectURL(blob);
            const downloadLink = document.getElementById("downloadLink");
            downloadLink.href = url;
            downloadLink.download = "documento.pdf";
            downloadLink.style.display = "block";
            downloadLink.innerText = "Descargar PDF";
        }
    </script>
</body>
</html>